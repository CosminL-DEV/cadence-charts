{{/*
This template creates secrets for all Cadence Server services (frontend, history, matching, worker)
It creates secrets from secretEnv configuration and automatically adds database/service passwords
*/}}

{{- $services := list "frontend" "history" "matching" "worker" -}}
{{- $hasGlobalSecrets := .Values.global.secretEnv -}}

{{- range $serviceName := $services -}}
{{- $service := index $.Values $serviceName -}}
{{- $hasServiceSecrets := $service.secretEnv -}}
{{- $globalSecrets := $.Values.global.secretEnv | default list -}}
{{- $serviceSecrets := $service.secretEnv | default list -}}
{{- $userSecrets := concat $globalSecrets $serviceSecrets -}}

{{- /* Get auto-generated database secrets */ -}}
{{- $databaseSecrets := include "cadence.databaseSecrets" $ | fromYaml -}}
{{- $mergedSecrets := concat $userSecrets $databaseSecrets -}}

{{- if $mergedSecrets }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "cadence.fullname" $ }}-{{ $serviceName }}-secrets
  labels:
    {{- include "cadence.labels" $ | nindent 4 }}
    app.kubernetes.io/component: {{ $serviceName }}
type: Opaque
data:
  {{- range $secret := $mergedSecrets }}
  {{- if $secret.value }}
  {{ $secret.name }}: {{ $secret.value | b64enc | quote }}
  {{- end }}
  {{- end }}
{{- end }}
{{- end }}